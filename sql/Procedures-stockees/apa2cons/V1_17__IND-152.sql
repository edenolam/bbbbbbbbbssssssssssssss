DELIMITER $$

DROP PROCEDURE IF EXISTS apa2cons_ind152
$$

CREATE PROCEDURE apa2cons_ind152(idBilaSociCons INT, idColl INT, idEnqu INT)
COMMENT ''
LANGUAGE SQL
NOT DETERMINISTIC
CONTAINS SQL
SQL SECURITY DEFINER
BEGIN
  ### Cr√©ation et remplissage de la table temporaire
  DROP TEMPORARY TABLE IF EXISTS temp_apa2cons_ind152;
  CREATE TEMPORARY TABLE temp_apa2cons_ind152 (INDEX(Q2_8))
    ENGINE = MEMORY
    AS (
      SELECT
        bsa.ID_CADREMPL AS Q2_8,
        bsa.CD_SEXE AS Q1,
        bsa.BL_TEMPCOMP AS Q11_1,		
        ma.CD_MOTIARRI AS Q5_4
      FROM bilan_social_agent AS bsa
        JOIN ref_statut AS rs ON bsa.ID_STAT = rs.ID_STAT  # Q2
        LEFT OUTER JOIN ref_motif_arrivee AS ma ON bsa.ID_MOTIARRI = ma.ID_MOTIARRI # Q5.4
      WHERE bsa.ID_COLL = idColl
        AND bsa.ID_ENQU = idEnqu        
        AND rs.CD_STAT IN ('TITU', 'STAG')  # Q2
		AND bsa.BL_AGENARRIANNECOLL = 1  #Q5.1
        AND bsa.ID_CADREMPL IS NOT NULL
    );

  ### Remplissage de 1.5.2
  INSERT INTO ind_152 (ID_BILASOCICONS, ID_CADREMPL, R_1521, R_1522, R_1523, R_1524, R_1525, R_1526, R_1527, R_1528, R_1529, R_15210, R_15211, R_15212, R_15213, R_15214, R_15215, R_15216, R_15217, R_15218, R_15219, R_15220, R_15221)
  SELECT idBilaSociCons, ce.ID_CADREMPL,
    SUM(CASE WHEN t.Q5_4 in ('MA022') THEN 1 ELSE 0 END) AS R_1521,
	SUM(CASE WHEN t.Q5_4 in ('MA023')  THEN 1 ELSE 0 END) AS R_1522,
	SUM(CASE WHEN t.Q5_4 in ('MA024')  THEN 1 ELSE 0 END) AS R_1523,
	SUM(CASE WHEN t.Q5_4 = 'MA025' THEN 1 ELSE 0 END) AS R_1524,#concours
	SUM(CASE WHEN t.Q5_4 = 'MA026' THEN 1 ELSE 0 END) AS R_1525, #concours
	SUM(CASE WHEN t.Q5_4 = 'MA027' THEN 1 ELSE 0 END) AS R_1526, #concours
	SUM(CASE WHEN t.Q5_4 = 'MA005' THEN 1 ELSE 0 END) AS R_1527, #38
	SUM(CASE WHEN t.Q5_4 = 'MA006' THEN 1 ELSE 0 END) AS R_1528, #intr direct
	SUM(CASE WHEN t.Q5_4 = 'MA007' THEN 1 ELSE 0 END) AS R_1529, #mutation
	SUM(CASE WHEN t.Q5_4 = 'MA008' THEN 1 ELSE 0 END) AS R_15210, #voie
	SUM(CASE WHEN t.Q5_4 = 'MA009' THEN 1 ELSE 0 END) AS R_15211, #voie
	SUM(CASE WHEN t.Q5_4 = 'MA010' THEN 1 ELSE 0 END) AS R_15212, #voie
	SUM(CASE WHEN t.Q5_4 = 'MA011' THEN 1 ELSE 0 END) AS R_15213, #voie
	SUM(CASE WHEN t.Q5_4 = 'MA013' THEN 1 ELSE 0 END) AS R_15214, #transf
	SUM(CASE WHEN t.Q5_4 = 'MA028' THEN 1 ELSE 0 END) AS R_15215, #reintr
	SUM(CASE WHEN t.Q5_4 = 'MA029' THEN 1 ELSE 0 END) AS R_15216, #reintr
	SUM(CASE WHEN t.Q5_4 = 'MA015' THEN 1 ELSE 0 END) AS R_15217, #retour
	SUM(CASE WHEN t.Q11_1 = 1 AND t.Q1 = 1 THEN 1 ELSE 0 END) AS R_15218,
	SUM(CASE WHEN t.Q11_1 = 1 AND t.Q1 = 2 THEN 1 ELSE 0 END) AS R_15219,
	SUM(CASE WHEN t.Q11_1 = 0 AND t.Q1 = 1 THEN 1 ELSE 0 END) AS R_15220,
	SUM(CASE WHEN t.Q11_1 = 0 AND t.Q1 = 2 THEN 1 ELSE 0 END) AS R_15221
  FROM ref_cadre_emploi ce
  LEFT JOIN temp_apa2cons_ind152 t on t.Q2_8 = ce.ID_CADREMPL
  WHERE ce.bl_vali = 0
  GROUP BY idBilaSociCons, ce.ID_CADREMPL
  ORDER BY ce.ID_CADREMPL;
  
END
$$
