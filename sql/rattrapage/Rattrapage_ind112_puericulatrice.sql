DELIMITER $$

DROP PROCEDURE IF EXISTS ratt_112_puericultrices
$$

CREATE PROCEDURE ratt_112_puericultrices()
COMMENT ''
LANGUAGE SQL
NOT DETERMINISTIC
CONTAINS SQL
SQL SECURITY DEFINER

BEGIN
	DECLARE cursIdBS INT(11);
	DECLARE R1121 INT(11);
   DECLARE R1122 INT(11);
   DECLARE R1123 INT(11);
   DECLARE R1124 INT(11);
   DECLARE R1125 INT(11);
   DECLARE R1126 INT(11);
   DECLARE R1127 INT(11);
   DECLARE R1128 INT(11);
   DECLARE vNb36 INT(11);
   
   DECLARE cursDone INT DEFAULT FALSE;
   DECLARE cursRattIndic112 CURSOR FOR 
			SELECT ind_112.ID_BILASOCICONS, SUM(COALESCE(ind_112.R_1121,0)), SUM(COALESCE(ind_112.R_1122,0)), SUM(COALESCE(ind_112.R_1123,0)),SUM(COALESCE(ind_112.R_1124,0)), SUM(COALESCE(ind_112.R_1125,0)), SUM(COALESCE(ind_112.R_1126,0)), SUM(COALESCE(ind_112.R_1127,0)), SUM(COALESCE(ind_112.R_1128,0)) 
			FROM ind_112 
			WHERE ind_112.ID_CADREMPL IN (35,36)
				GROUP BY ind_112.ID_BILASOCICONS;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET cursDone = TRUE;
    OPEN cursRattIndic112;
    ratt_ind112_loop:LOOP
      FETCH cursRattIndic112
      INTO cursIdBS, R1121, R1122,R1123,R1124,R1125,R1126,R1127,R1128;
      IF cursDone
      THEN
        LEAVE ratt_ind112_loop;
      END IF;
      
      SELECT COUNT(1) INTO vNb36 FROM ind_112 WHERE ID_CADREMPL = 36 AND ID_BILASOCICONS = cursIdBS;
      IF vNb36 > 0 THEN
	      UPDATE ind_112
		  		SET R_1121 = R1121, R_1122 = R1122, R_1123 = R1123, R_1124 = R1124, R_1125 = R1125, R_1126 = R1126, R_1127 = R1127, R_1128 = R1128, CD_UTILMODI = 'RATT'
		  	WHERE ID_BILASOCICONS = cursIdBS
				AND ID_CADREMPL = 36;
	    	UPDATE ind_112 
		 		SET R_1121 = 0, R_1122 = 0, R_1123 = 0, R_1124 = 0, R_1125 = 0, R_1126 = 0, R_1127 = 0, R_1128 = 0, CD_UTILMODI = 'RATT'
		 	WHERE ID_BILASOCICONS = cursIdBS
				AND ID_CADREMPL = 35;
		ELSE
		 	UPDATE ind_112 
		 		SET ID_CADREMPL = 36, CD_UTILMODI = 'RATT'
		 	WHERE ID_BILASOCICONS = cursIdBS
				AND ID_CADREMPL = 35;
		END IF;
    END LOOP;
    CLOSE cursRattIndic112;
  END
$$